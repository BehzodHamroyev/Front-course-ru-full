const React = require('react');

const importJsx = require('import-jsx');

const {
  Static,
  Box
} = require('ink');

const {
  STATUS_NOT_STARTED,
  STATUS_RUNNING,
  STATUS_SUCCEEDED,
  STATUS_FAILED
} = require('../../task-runner');

const {
  TASK_TYPE_PREPARE,
  TASK_TYPE_START,
  TASK_TYPE_FETCH_STORIES,
  TASK_TYPE_TESTS,
  TASK_TYPE_TEST,
  TASK_TYPE_STOP
} = require('../../constants');

const Task = importJsx('./Task');
const FailedTest = importJsx('./FailedTest');

const collectRecursively = (predicate, tasks, collection = []) => {
  for (let i = 0; i < tasks.length; i++) {
    const task = tasks[i];

    if (predicate(task)) {
      collection.push(task);
    }

    if (task.tasks) {
      return collectRecursively(predicate, task.tasks, collection);
    }
  }

  return collection;
};

const isRunningTest = task => task.status === STATUS_RUNNING && task.meta.type === TASK_TYPE_TEST;

const isCompletedTest = task => (task.status === STATUS_FAILED || task.status === STATUS_SUCCEEDED) && task.meta.type === TASK_TYPE_TEST;

const isFailedTest = task => task.status === STATUS_FAILED && task.meta.type === TASK_TYPE_TEST;

const isFailedTask = task => task.status === STATUS_FAILED && task.meta.type !== TASK_TYPE_TESTS;

const groupByKind = testTasks => testTasks.reduce((acc, task) => {
  const key = `${task.meta.target}/${task.meta.configuration}/${task.meta.kind}`;

  if (!acc[key]) {
    acc[key] = {
      target: task.meta.target,
      configuration: task.meta.configuration,
      kind: task.meta.kind,
      tasks: []
    };
  }

  acc[key].tasks.push(task);
  return acc;
}, {});

const KindTask = ({
  status,
  target,
  configuration,
  kind
}) => /*#__PURE__*/React.createElement(Task, {
  status: status,
  prefix: `${target}/${configuration}/`,
  title: kind
});

const TARGET_TASK_TITLE_MAP = {
  [TASK_TYPE_PREPARE]: 'Preparing',
  [TASK_TYPE_START]: 'Starting',
  [TASK_TYPE_FETCH_STORIES]: 'Fetching stories',
  [TASK_TYPE_TESTS]: 'Running tests',
  [TASK_TYPE_STOP]: 'Stopping'
};

const TargetTask = ({
  status,
  target,
  tasks
}) => {
  const currentTask = tasks && tasks.find(task => task.status === STATUS_NOT_STARTED || task.status === STATUS_RUNNING);
  const taskTitle = currentTask && TARGET_TASK_TITLE_MAP[currentTask.meta.type];
  const failedTasks = (tasks || []).filter(isFailedTask);
  return /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(Task, {
    status: status,
    title: `${target}${status !== STATUS_FAILED && taskTitle ? `: ${taskTitle}` : ''}`
  }), failedTasks.map(task => /*#__PURE__*/React.createElement(FailedTest, {
    key: task.id,
    title: TARGET_TASK_TITLE_MAP[task.meta.type],
    error: task.error
  })));
};

const renderFailedTasks = tasks => tasks.filter(isFailedTest).map(task => /*#__PURE__*/React.createElement(FailedTest, {
  key: task.id,
  title: task.meta.story,
  error: task.error
}));

const renderKind = ({
  key,
  status,
  target,
  configuration,
  kind,
  tasks
}) => /*#__PURE__*/React.createElement(React.Fragment, {
  key: key
}, /*#__PURE__*/React.createElement(KindTask, {
  status: status,
  target: target,
  configuration: configuration,
  kind: kind
}), renderFailedTasks(tasks));

const renderKinds = kinds => kinds.map(renderKind);

const TaskList = ({
  tasks
}) => {
  const runningGrouped = groupByKind(collectRecursively(isRunningTest, tasks));
  const running = Object.keys(runningGrouped).map(key => ({
    key,
    ...runningGrouped[key],
    status: STATUS_RUNNING
  }));
  const completedGrouped = groupByKind(collectRecursively(isCompletedTest, tasks));
  const completed = Object.keys(completedGrouped).filter(key => !runningGrouped[key]).map(key => ({
    key,
    ...completedGrouped[key],
    status: completedGrouped[key].tasks.find(test => test.status === STATUS_FAILED) ? STATUS_FAILED : STATUS_SUCCEEDED,
    completedAt: completedGrouped[key].tasks.reduce((acc, task) => Math.max(acc, task.completedAt), 0)
  })).sort((a, b) => a.completedAt - b.completedAt);
  return /*#__PURE__*/React.createElement(Box, {
    flexDirection: "column"
  }, /*#__PURE__*/React.createElement(Static, {
    items: completed
  }, renderKind), renderKinds(running), tasks.map(task => /*#__PURE__*/React.createElement(TargetTask, {
    key: task.id,
    status: task.status,
    target: task.id,
    tasks: task.tasks
  })));
};

module.exports = TaskList;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlRhc2tMaXN0LmpzIl0sIm5hbWVzIjpbIlJlYWN0IiwicmVxdWlyZSIsImltcG9ydEpzeCIsIlN0YXRpYyIsIkJveCIsIlNUQVRVU19OT1RfU1RBUlRFRCIsIlNUQVRVU19SVU5OSU5HIiwiU1RBVFVTX1NVQ0NFRURFRCIsIlNUQVRVU19GQUlMRUQiLCJUQVNLX1RZUEVfUFJFUEFSRSIsIlRBU0tfVFlQRV9TVEFSVCIsIlRBU0tfVFlQRV9GRVRDSF9TVE9SSUVTIiwiVEFTS19UWVBFX1RFU1RTIiwiVEFTS19UWVBFX1RFU1QiLCJUQVNLX1RZUEVfU1RPUCIsIlRhc2siLCJGYWlsZWRUZXN0IiwiY29sbGVjdFJlY3Vyc2l2ZWx5IiwicHJlZGljYXRlIiwidGFza3MiLCJjb2xsZWN0aW9uIiwiaSIsImxlbmd0aCIsInRhc2siLCJwdXNoIiwiaXNSdW5uaW5nVGVzdCIsInN0YXR1cyIsIm1ldGEiLCJ0eXBlIiwiaXNDb21wbGV0ZWRUZXN0IiwiaXNGYWlsZWRUZXN0IiwiaXNGYWlsZWRUYXNrIiwiZ3JvdXBCeUtpbmQiLCJ0ZXN0VGFza3MiLCJyZWR1Y2UiLCJhY2MiLCJrZXkiLCJ0YXJnZXQiLCJjb25maWd1cmF0aW9uIiwia2luZCIsIktpbmRUYXNrIiwiVEFSR0VUX1RBU0tfVElUTEVfTUFQIiwiVGFyZ2V0VGFzayIsImN1cnJlbnRUYXNrIiwiZmluZCIsInRhc2tUaXRsZSIsImZhaWxlZFRhc2tzIiwiZmlsdGVyIiwibWFwIiwiaWQiLCJlcnJvciIsInJlbmRlckZhaWxlZFRhc2tzIiwic3RvcnkiLCJyZW5kZXJLaW5kIiwicmVuZGVyS2luZHMiLCJraW5kcyIsIlRhc2tMaXN0IiwicnVubmluZ0dyb3VwZWQiLCJydW5uaW5nIiwiT2JqZWN0Iiwia2V5cyIsImNvbXBsZXRlZEdyb3VwZWQiLCJjb21wbGV0ZWQiLCJ0ZXN0IiwiY29tcGxldGVkQXQiLCJNYXRoIiwibWF4Iiwic29ydCIsImEiLCJiIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6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c3QgaW1wb3J0SnN4ID0gcmVxdWlyZSgnaW1wb3J0LWpzeCcpO1xuY29uc3QgeyBTdGF0aWMsIEJveCB9ID0gcmVxdWlyZSgnaW5rJyk7XG5jb25zdCB7XG4gIFNUQVRVU19OT1RfU1RBUlRFRCxcbiAgU1RBVFVTX1JVTk5JTkcsXG4gIFNUQVRVU19TVUNDRUVERUQsXG4gIFNUQVRVU19GQUlMRUQsXG59ID0gcmVxdWlyZSgnLi4vLi4vdGFzay1ydW5uZXInKTtcbmNvbnN0IHtcbiAgVEFTS19UWVBFX1BSRVBBUkUsXG4gIFRBU0tfVFlQRV9TVEFSVCxcbiAgVEFTS19UWVBFX0ZFVENIX1NUT1JJRVMsXG4gIFRBU0tfVFlQRV9URVNUUyxcbiAgVEFTS19UWVBFX1RFU1QsXG4gIFRBU0tfVFlQRV9TVE9QLFxufSA9IHJlcXVpcmUoJy4uLy4uL2NvbnN0YW50cycpO1xuXG5jb25zdCBUYXNrID0gaW1wb3J0SnN4KCcuL1Rhc2snKTtcbmNvbnN0IEZhaWxlZFRlc3QgPSBpbXBvcnRKc3goJy4vRmFpbGVkVGVzdCcpO1xuXG5jb25zdCBjb2xsZWN0UmVjdXJzaXZlbHkgPSAocHJlZGljYXRlLCB0YXNrcywgY29sbGVjdGlvbiA9IFtdKSA9PiB7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgdGFza3MubGVuZ3RoOyBpKyspIHtcbiAgICBjb25zdCB0YXNrID0gdGFza3NbaV07XG4gICAgaWYgKHByZWRpY2F0ZSh0YXNrKSkge1xuICAgICAgY29sbGVjdGlvbi5wdXNoKHRhc2spO1xuICAgIH1cbiAgICBpZiAodGFzay50YXNrcykge1xuICAgICAgcmV0dXJuIGNvbGxlY3RSZWN1cnNpdmVseShwcmVkaWNhdGUsIHRhc2sudGFza3MsIGNvbGxlY3Rpb24pO1xuICAgIH1cbiAgfVxuICByZXR1cm4gY29sbGVjdGlvbjtcbn07XG5cbmNvbnN0IGlzUnVubmluZ1Rlc3QgPSAodGFzaykgPT5cbiAgdGFzay5zdGF0dXMgPT09IFNUQVRVU19SVU5OSU5HICYmIHRhc2subWV0YS50eXBlID09PSBUQVNLX1RZUEVfVEVTVDtcblxuY29uc3QgaXNDb21wbGV0ZWRUZXN0ID0gKHRhc2spID0+XG4gICh0YXNrLnN0YXR1cyA9PT0gU1RBVFVTX0ZBSUxFRCB8fCB0YXNrLnN0YXR1cyA9PT0gU1RBVFVTX1NVQ0NFRURFRCkgJiZcbiAgdGFzay5tZXRhLnR5cGUgPT09IFRBU0tfVFlQRV9URVNUO1xuXG5jb25zdCBpc0ZhaWxlZFRlc3QgPSAodGFzaykgPT5cbiAgdGFzay5zdGF0dXMgPT09IFNUQVRVU19GQUlMRUQgJiYgdGFzay5tZXRhLnR5cGUgPT09IFRBU0tfVFlQRV9URVNUO1xuXG5jb25zdCBpc0ZhaWxlZFRhc2sgPSAodGFzaykgPT5cbiAgdGFzay5zdGF0dXMgPT09IFNUQVRVU19GQUlMRUQgJiYgdGFzay5tZXRhLnR5cGUgIT09IFRBU0tfVFlQRV9URVNUUztcblxuY29uc3QgZ3JvdXBCeUtpbmQgPSAodGVzdFRhc2tzKSA9PlxuICB0ZXN0VGFza3MucmVkdWNlKChhY2MsIHRhc2spID0+IHtcbiAgICBjb25zdCBrZXkgPSBgJHt0YXNrLm1ldGEudGFyZ2V0fS8ke3Rhc2subWV0YS5jb25maWd1cmF0aW9ufS8ke3Rhc2subWV0YS5raW5kfWA7XG4gICAgaWYgKCFhY2Nba2V5XSkge1xuICAgICAgYWNjW2tleV0gPSB7XG4gICAgICAgIHRhcmdldDogdGFzay5tZXRhLnRhcmdldCxcbiAgICAgICAgY29uZmlndXJhdGlvbjogdGFzay5tZXRhLmNvbmZpZ3VyYXRpb24sXG4gICAgICAgIGtpbmQ6IHRhc2subWV0YS5raW5kLFxuICAgICAgICB0YXNrczogW10sXG4gICAgICB9O1xuICAgIH1cbiAgICBhY2Nba2V5XS50YXNrcy5wdXNoKHRhc2spO1xuICAgIHJldHVybiBhY2M7XG4gIH0sIHt9KTtcblxuY29uc3QgS2luZFRhc2sgPSAoeyBzdGF0dXMsIHRhcmdldCwgY29uZmlndXJhdGlvbiwga2luZCB9KSA9PiAoXG4gIDxUYXNrIHN0YXR1cz17c3RhdHVzfSBwcmVmaXg9e2Ake3RhcmdldH0vJHtjb25maWd1cmF0aW9ufS9gfSB0aXRsZT17a2luZH0gLz5cbik7XG5cbmNvbnN0IFRBUkdFVF9UQVNLX1RJVExFX01BUCA9IHtcbiAgW1RBU0tfVFlQRV9QUkVQQVJFXTogJ1ByZXBhcmluZycsXG4gIFtUQVNLX1RZUEVfU1RBUlRdOiAnU3RhcnRpbmcnLFxuICBbVEFTS19UWVBFX0ZFVENIX1NUT1JJRVNdOiAnRmV0Y2hpbmcgc3RvcmllcycsXG4gIFtUQVNLX1RZUEVfVEVTVFNdOiAnUnVubmluZyB0ZXN0cycsXG4gIFtUQVNLX1RZUEVfU1RPUF06ICdTdG9wcGluZycsXG59O1xuY29uc3QgVGFyZ2V0VGFzayA9ICh7IHN0YXR1cywgdGFyZ2V0LCB0YXNrcyB9KSA9PiB7XG4gIGNvbnN0IGN1cnJlbnRUYXNrID1cbiAgICB0YXNrcyAmJlxuICAgIHRhc2tzLmZpbmQoXG4gICAgICAodGFzaykgPT5cbiAgICAgICAgdGFzay5zdGF0dXMgPT09IFNUQVRVU19OT1RfU1RBUlRFRCB8fCB0YXNrLnN0YXR1cyA9PT0gU1RBVFVTX1JVTk5JTkdcbiAgICApO1xuICBjb25zdCB0YXNrVGl0bGUgPSBjdXJyZW50VGFzayAmJiBUQVJHRVRfVEFTS19USVRMRV9NQVBbY3VycmVudFRhc2subWV0YS50eXBlXTtcbiAgY29uc3QgZmFpbGVkVGFza3MgPSAodGFza3MgfHwgW10pLmZpbHRlcihpc0ZhaWxlZFRhc2spO1xuXG4gIHJldHVybiAoXG4gICAgPFJlYWN0LkZyYWdtZW50PlxuICAgICAgPFRhc2tcbiAgICAgICAgc3RhdHVzPXtzdGF0dXN9XG4gICAgICAgIHRpdGxlPXtgJHt0YXJnZXR9JHtcbiAgICAgICAgICBzdGF0dXMgIT09IFNUQVRVU19GQUlMRUQgJiYgdGFza1RpdGxlID8gYDogJHt0YXNrVGl0bGV9YCA6ICcnXG4gICAgICAgIH1gfVxuICAgICAgLz5cbiAgICAgIHtmYWlsZWRUYXNrcy5tYXAoKHRhc2spID0+IChcbiAgICAgICAgPEZhaWxlZFRlc3RcbiAgICAgICAgICBrZXk9e3Rhc2suaWR9XG4gICAgICAgICAgdGl0bGU9e1RBUkdFVF9UQVNLX1RJVExFX01BUFt0YXNrLm1ldGEudHlwZV19XG4gICAgICAgICAgZXJyb3I9e3Rhc2suZXJyb3J9XG4gICAgICAgIC8+XG4gICAgICApKX1cbiAgICA8L1JlYWN0LkZyYWdtZW50PlxuICApO1xufTtcblxuY29uc3QgcmVuZGVyRmFpbGVkVGFza3MgPSAodGFza3MpID0+XG4gIHRhc2tzXG4gICAgLmZpbHRlcihpc0ZhaWxlZFRlc3QpXG4gICAgLm1hcCgodGFzaykgPT4gKFxuICAgICAgPEZhaWxlZFRlc3Qga2V5PXt0YXNrLmlkfSB0aXRsZT17dGFzay5tZXRhLnN0b3J5fSBlcnJvcj17dGFzay5lcnJvcn0gLz5cbiAgICApKTtcblxuY29uc3QgcmVuZGVyS2luZCA9ICh7IGtleSwgc3RhdHVzLCB0YXJnZXQsIGNvbmZpZ3VyYXRpb24sIGtpbmQsIHRhc2tzIH0pID0+IChcbiAgPFJlYWN0LkZyYWdtZW50IGtleT17a2V5fT5cbiAgICA8S2luZFRhc2tcbiAgICAgIHN0YXR1cz17c3RhdHVzfVxuICAgICAgdGFyZ2V0PXt0YXJnZXR9XG4gICAgICBjb25maWd1cmF0aW9uPXtjb25maWd1cmF0aW9ufVxuICAgICAga2luZD17a2luZH1cbiAgICAvPlxuICAgIHtyZW5kZXJGYWlsZWRUYXNrcyh0YXNrcyl9XG4gIDwvUmVhY3QuRnJhZ21lbnQ+XG4pO1xuXG5jb25zdCByZW5kZXJLaW5kcyA9IChraW5kcykgPT4ga2luZHMubWFwKHJlbmRlcktpbmQpO1xuXG5jb25zdCBUYXNrTGlzdCA9ICh7IHRhc2tzIH0pID0+IHtcbiAgY29uc3QgcnVubmluZ0dyb3VwZWQgPSBncm91cEJ5S2luZChjb2xsZWN0UmVjdXJzaXZlbHkoaXNSdW5uaW5nVGVzdCwgdGFza3MpKTtcbiAgY29uc3QgcnVubmluZyA9IE9iamVjdC5rZXlzKHJ1bm5pbmdHcm91cGVkKS5tYXAoKGtleSkgPT4gKHtcbiAgICBrZXksXG4gICAgLi4ucnVubmluZ0dyb3VwZWRba2V5XSxcbiAgICBzdGF0dXM6IFNUQVRVU19SVU5OSU5HLFxuICB9KSk7XG5cbiAgY29uc3QgY29tcGxldGVkR3JvdXBlZCA9IGdyb3VwQnlLaW5kKFxuICAgIGNvbGxlY3RSZWN1cnNpdmVseShpc0NvbXBsZXRlZFRlc3QsIHRhc2tzKVxuICApO1xuICBjb25zdCBjb21wbGV0ZWQgPSBPYmplY3Qua2V5cyhjb21wbGV0ZWRHcm91cGVkKVxuICAgIC5maWx0ZXIoKGtleSkgPT4gIXJ1bm5pbmdHcm91cGVkW2tleV0pXG4gICAgLm1hcCgoa2V5KSA9PiAoe1xuICAgICAga2V5LFxuICAgICAgLi4uY29tcGxldGVkR3JvdXBlZFtrZXldLFxuICAgICAgc3RhdHVzOiBjb21wbGV0ZWRHcm91cGVkW2tleV0udGFza3MuZmluZChcbiAgICAgICAgKHRlc3QpID0+IHRlc3Quc3RhdHVzID09PSBTVEFUVVNfRkFJTEVEXG4gICAgICApXG4gICAgICAgID8gU1RBVFVTX0ZBSUxFRFxuICAgICAgICA6IFNUQVRVU19TVUNDRUVERUQsXG4gICAgICBjb21wbGV0ZWRBdDogY29tcGxldGVkR3JvdXBlZFtrZXldLnRhc2tzLnJlZHVjZShcbiAgICAgICAgKGFjYywgdGFzaykgPT4gTWF0aC5tYXgoYWNjLCB0YXNrLmNvbXBsZXRlZEF0KSxcbiAgICAgICAgMFxuICAgICAgKSxcbiAgICB9KSlcbiAgICAuc29ydCgoYSwgYikgPT4gYS5jb21wbGV0ZWRBdCAtIGIuY29tcGxldGVkQXQpO1xuXG4gIHJldHVybiAoXG4gICAgPEJveCBmbGV4RGlyZWN0aW9uPVwiY29sdW1uXCI+XG4gICAgICA8U3RhdGljIGl0ZW1zPXtjb21wbGV0ZWR9PntyZW5kZXJLaW5kfTwvU3RhdGljPlxuICAgICAge3JlbmRlcktpbmRzKHJ1bm5pbmcpfVxuICAgICAge3Rhc2tzLm1hcCgodGFzaykgPT4gKFxuICAgICAgICA8VGFyZ2V0VGFza1xuICAgICAgICAgIGtleT17dGFzay5pZH1cbiAgICAgICAgICBzdGF0dXM9e3Rhc2suc3RhdHVzfVxuICAgICAgICAgIHRhcmdldD17dGFzay5pZH1cbiAgICAgICAgICB0YXNrcz17dGFzay50YXNrc31cbiAgICAgICAgLz5cbiAgICAgICkpfVxuICAgIDwvQm94PlxuICApO1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSBUYXNrTGlzdDtcbiJdfQ==